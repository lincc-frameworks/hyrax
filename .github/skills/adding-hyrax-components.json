{
  "name": "Adding Hyrax Components",
  "description": "Step-by-step guide for adding new models, datasets, and verbs to Hyrax with proper registration",
  "version": "1.0.0",
  "tags": ["development", "models", "datasets", "verbs", "plugins"],
  "instructions": "This skill provides structured guidance for adding new components to Hyrax, including models, datasets, and verbs with proper registration and decorator usage.\n\n## When to Use\n\nUse this skill when:\n- Adding a new machine learning model to Hyrax\n- Creating a new dataset class for data access\n- Implementing a new CLI verb/command\n- Troubleshooting component registration issues\n- Understanding decorator requirements\n\n## Adding a New Model\n\n### Model Requirements\n\nAll Hyrax models MUST implement:\n1. `forward()` - Forward pass through model\n2. `train_step()` - Single training step logic\n3. `prepare_inputs()` - Data preparation (replaces deprecated `to_tensor()`)\n\n### Step-by-Step Process\n\n#### 1. Create Model File\n\nLocation: `src/hyrax/models/my_model.py`\n\n```python\nimport torch\nimport torch.nn as nn\nfrom hyrax.models.model_registry import hyrax_model\n\n@hyrax_model(\"MyModel\")\nclass MyModel(nn.Module):\n    \"\"\"My custom model for astronomy tasks.\n    \n    This model implements <describe architecture>.\n    \"\"\"\n    \n    def __init__(self, config):\n        \"\"\"Initialize model.\n        \n        Args:\n            config: Hyrax config dictionary\n        \"\"\"\n        super().__init__()\n        self.config = config\n        \n        # Build model layers\n        self.encoder = nn.Sequential(\n            nn.Linear(config[\"model\"][\"input_dim\"], 128),\n            nn.ReLU(),\n            nn.Linear(128, config[\"model\"][\"latent_dim\"])\n        )\n    \n    def forward(self, x):\n        \"\"\"Forward pass.\n        \n        Args:\n            x: Input tensor\n            \n        Returns:\n            Model output\n        \"\"\"\n        return self.encoder(x)\n    \n    def train_step(self, batch, optimizer, device):\n        \"\"\"Single training step.\n        \n        Args:\n            batch: Dictionary with batch data\n            optimizer: PyTorch optimizer\n            device: torch device\n            \n        Returns:\n            Dictionary with 'loss' and optional metrics\n        \"\"\"\n        # Prepare inputs\n        inputs = self.prepare_inputs(batch, device)\n        \n        # Forward pass\n        outputs = self(inputs)\n        \n        # Compute loss\n        loss = compute_loss(outputs, batch)\n        \n        # Backward pass\n        optimizer.zero_grad()\n        loss.backward()\n        optimizer.step()\n        \n        return {\"loss\": loss.item()}\n    \n    def prepare_inputs(self, batch, device):\n        \"\"\"Prepare batch data for model input.\n        \n        Args:\n            batch: Dictionary with batch data\n            device: torch device\n            \n        Returns:\n            Prepared input tensor\n        \"\"\"\n        # Extract and prepare inputs\n        images = batch[\"image\"]\n        return images.to(device)\n```\n\n#### 2. Register Model (Automatic)\n\nThe `@hyrax_model(\"MyModel\")` decorator handles:\n- Automatic registration in model registry\n- Shape inference for model outputs\n- CLI integration\n\n#### 3. Add Default Config\n\nLocation: `src/hyrax/models/my_model_default_config.toml`\n\n```toml\n[model]\nname = \"MyModel\"\ninput_dim = 1024\nlatent_dim = 128\nlearning_rate = 0.001\n```\n\n#### 4. Import in `__init__.py`\n\nLocation: `src/hyrax/models/__init__.py`\n\n```python\nfrom .my_model import MyModel\n\n__all__ = [..., \"MyModel\"]\n```\n\n#### 5. Test the Model\n\n```python\n# tests/hyrax/models/test_my_model.py\nimport pytest\nfrom hyrax import Hyrax\nfrom hyrax.models import MyModel\n\ndef test_my_model_creation():\n    \"\"\"Test model can be created.\"\"\"\n    config = {\"model\": {\"name\": \"MyModel\", \"input_dim\": 100, \"latent_dim\": 32}}\n    model = MyModel(config)\n    assert model is not None\n\ndef test_my_model_forward():\n    \"\"\"Test forward pass.\"\"\"\n    config = {\"model\": {\"name\": \"MyModel\", \"input_dim\": 100, \"latent_dim\": 32}}\n    model = MyModel(config)\n    x = torch.randn(10, 100)\n    output = model(x)\n    assert output.shape == (10, 32)\n```\n\n#### 6. Use via CLI\n\n```bash\n# Create config.toml with:\n# [model]\n# name = \"MyModel\"\n# input_dim = 1024\n# latent_dim = 128\n\nhyrax train -c config.toml\n```\n\n## Adding a New Dataset\n\n### Dataset Requirements\n\nAll Hyrax datasets MUST:\n1. Subclass `HyraxDataset` or `HyraxImageDataset`\n2. Set `_name` class attribute (triggers auto-registration)\n3. Implement: `__len__()`, `__getitem__()`, metadata interface\n\n### Step-by-Step Process\n\n#### 1. Create Dataset File\n\nLocation: `src/hyrax/data_sets/my_dataset.py`\n\n```python\nimport torch\nfrom pathlib import Path\nfrom hyrax.data_sets.hyrax_image_dataset import HyraxImageDataset\n\nclass MyDataset(HyraxImageDataset):\n    \"\"\"Custom dataset for my astronomy data.\n    \n    This dataset loads <describe data source>.\n    \"\"\"\n    \n    # Auto-registration via _name attribute\n    _name = \"MyDataset\"\n    \n    def __init__(self, config, split=\"train\"):\n        \"\"\"Initialize dataset.\n        \n        Args:\n            config: Hyrax config dictionary\n            split: Data split (train/val/test)\n        \"\"\"\n        super().__init__(config, split)\n        \n        # Load data file list\n        self.data_dir = Path(config[\"data\"][\"root_dir\"])\n        self.file_list = self._load_file_list(split)\n    \n    def __len__(self):\n        \"\"\"Return dataset size.\"\"\"\n        return len(self.file_list)\n    \n    def __getitem__(self, idx):\n        \"\"\"Get single data item.\n        \n        Args:\n            idx: Index\n            \n        Returns:\n            Dictionary with data item\n        \"\"\"\n        # Load image\n        image_path = self.file_list[idx]\n        image = self._load_image(image_path)\n        \n        # Apply transforms (handled by HyraxImageDataset)\n        if self.transform:\n            image = self.transform(image)\n        \n        return {\n            \"image\": image,\n            \"label\": self._get_label(idx),\n            \"metadata\": self._get_metadata(idx)\n        }\n    \n    def _load_file_list(self, split):\n        \"\"\"Load list of files for split.\"\"\"\n        split_file = self.data_dir / f\"{split}.txt\"\n        with open(split_file) as f:\n            return [line.strip() for line in f]\n    \n    def _load_image(self, path):\n        \"\"\"Load single image.\"\"\"\n        # Implementation depends on image format\n        pass\n    \n    def _get_label(self, idx):\n        \"\"\"Get label for item.\"\"\"\n        # Return label if supervised, None if unsupervised\n        pass\n    \n    def _get_metadata(self, idx):\n        \"\"\"Get metadata for item.\"\"\"\n        return {\"index\": idx, \"path\": str(self.file_list[idx])}\n```\n\n#### 2. Registration (Automatic)\n\nSetting `_name = \"MyDataset\"` triggers automatic registration via `__init_subclass__`.\n\n#### 3. Add Default Config\n\nLocation: `src/hyrax/data_sets/my_dataset_default_config.toml`\n\n```toml\n[data]\nname = \"MyDataset\"\nroot_dir = \"/path/to/data\"\nbatch_size = 32\nnum_workers = 4\n```\n\n#### 4. Import in `__init__.py`\n\nLocation: `src/hyrax/data_sets/__init__.py`\n\n```python\nfrom .my_dataset import MyDataset\n\n__all__ = [..., \"MyDataset\"]\n```\n\n#### 5. Test the Dataset\n\n```python\n# tests/hyrax/data_sets/test_my_dataset.py\nimport pytest\nfrom hyrax.data_sets import MyDataset\n\ndef test_my_dataset_creation(tmp_path):\n    \"\"\"Test dataset can be created.\"\"\"\n    config = {\"data\": {\"name\": \"MyDataset\", \"root_dir\": str(tmp_path)}}\n    dataset = MyDataset(config)\n    assert dataset is not None\n\ndef test_my_dataset_length(tmp_path):\n    \"\"\"Test dataset length.\"\"\"\n    # Setup test data\n    dataset = MyDataset(config)\n    assert len(dataset) > 0\n\ndef test_my_dataset_getitem(tmp_path):\n    \"\"\"Test getting data item.\"\"\"\n    dataset = MyDataset(config)\n    item = dataset[0]\n    assert \"image\" in item\n    assert \"label\" in item\n```\n\n## Adding a New Verb\n\n### Verb Requirements\n\nAll Hyrax verbs MUST:\n1. Use `@hyrax_verb(\"verb_name\")` decorator\n2. Implement `run()` and `run_cli()` methods\n3. Implement `setup_parser(parser)` for CLI args\n4. Set `add_parser_kwargs` for help text\n\n### Step-by-Step Process\n\n#### 1. Create Verb File\n\nLocation: `src/hyrax/verbs/my_verb.py`\n\n```python\nimport argparse\nfrom pathlib import Path\nfrom hyrax.verbs.verb_registry import hyrax_verb\nfrom hyrax import Hyrax\n\n@hyrax_verb(\"myverb\")\nclass MyVerb:\n    \"\"\"Custom verb for doing something useful.\n    \n    This verb performs <describe functionality>.\n    \"\"\"\n    \n    # Help text for CLI\n    add_parser_kwargs = {\n        \"help\": \"Perform my custom operation\",\n        \"description\": \"Detailed description of what this verb does.\"\n    }\n    \n    @staticmethod\n    def setup_parser(parser):\n        \"\"\"Setup argument parser for CLI.\n        \n        Args:\n            parser: argparse.ArgumentParser\n        \"\"\"\n        parser.add_argument(\n            \"-c\", \"--config\",\n            type=str,\n            required=True,\n            help=\"Path to configuration file\"\n        )\n        parser.add_argument(\n            \"-o\", \"--output\",\n            type=str,\n            help=\"Output directory\"\n        )\n        parser.add_argument(\n            \"--option\",\n            action=\"store_true\",\n            help=\"Enable optional behavior\"\n        )\n    \n    @staticmethod\n    def run(config, output_dir=None, option=False):\n        \"\"\"Execute verb logic.\n        \n        Args:\n            config: Hyrax config dictionary\n            output_dir: Optional output directory\n            option: Optional flag\n            \n        Returns:\n            Results dictionary\n        \"\"\"\n        # Initialize Hyrax\n        hyrax = Hyrax(config)\n        \n        # Perform verb logic\n        results = perform_operation(hyrax, output_dir, option)\n        \n        # Save results\n        if output_dir:\n            save_results(results, output_dir)\n        \n        return results\n    \n    @staticmethod\n    def run_cli(args):\n        \"\"\"Execute verb from CLI.\n        \n        Args:\n            args: Parsed command line arguments\n            \n        Returns:\n            Exit code (0 for success)\n        \"\"\"\n        # Load config\n        config = load_config(args.config)\n        \n        # Run verb\n        results = MyVerb.run(\n            config,\n            output_dir=args.output,\n            option=args.option\n        )\n        \n        # Print summary\n        print(f\"Operation complete: {results['summary']}\")\n        \n        return 0\n```\n\n#### 2. Registration (Automatic)\n\nThe `@hyrax_verb(\"myverb\")` decorator handles automatic CLI registration.\n\n#### 3. Import in `__init__.py`\n\nLocation: `src/hyrax/verbs/__init__.py`\n\n```python\nfrom .my_verb import MyVerb\n\n__all__ = [..., \"MyVerb\"]\n```\n\n#### 4. Test the Verb\n\n```python\n# tests/hyrax/verbs/test_my_verb.py\nimport pytest\nfrom hyrax.verbs import MyVerb\n\ndef test_my_verb_run(default_config):\n    \"\"\"Test verb execution.\"\"\"\n    results = MyVerb.run(default_config)\n    assert results is not None\n    assert \"summary\" in results\n\ndef test_my_verb_cli(tmp_path, default_config):\n    \"\"\"Test CLI execution.\"\"\"\n    # Save config\n    config_path = tmp_path / \"config.toml\"\n    save_config(default_config, config_path)\n    \n    # Mock CLI args\n    args = argparse.Namespace(\n        config=str(config_path),\n        output=str(tmp_path),\n        option=True\n    )\n    \n    # Run CLI\n    exit_code = MyVerb.run_cli(args)\n    assert exit_code == 0\n```\n\n#### 5. Use via CLI\n\n```bash\n# View help\nhyrax myverb --help\n\n# Execute verb\nhyrax myverb -c config.toml -o output/ --option\n```\n\n## Common Registration Issues\n\n### Model Not Registering\n\n**Problem**: Model not available in CLI\n\n**Solutions**:\n1. Verify `@hyrax_model(\"ModelName\")` decorator present\n2. Check model imported in `src/hyrax/models/__init__.py`\n3. Ensure decorator uses correct string name\n4. Check for syntax errors in model file\n\n### Dataset Not Registering\n\n**Problem**: Dataset not found by name\n\n**Solutions**:\n1. Verify `_name` class attribute is set\n2. Check dataset imported in `src/hyrax/data_sets/__init__.py`\n3. Ensure `_name` matches config `[data] name = \"...\"`\n4. Check class actually subclasses `HyraxDataset` or `HyraxImageDataset`\n\n### Verb Not in CLI\n\n**Problem**: Verb command not available\n\n**Solutions**:\n1. Verify `@hyrax_verb(\"verb_name\")` decorator present\n2. Check verb imported in `src/hyrax/verbs/__init__.py`\n3. Ensure `setup_parser()` and `run_cli()` methods exist\n4. Check `add_parser_kwargs` is set\n5. Verify no syntax errors in verb file\n\n## External Plugins\n\nFor external packages:\n```toml\n[model]\nname = \"my_package.MyModel\"  # Triggers auto-load of my_package/default_config.toml\n```\n\nHyrax will:\n1. Import `my_package.MyModel`\n2. Look for `my_package/default_config.toml`\n3. Merge with local config\n\n## Best Practices\n\n### Models\n1. Use descriptive model names\n2. Document architecture in docstring\n3. Implement all required methods\n4. Use `prepare_inputs()`, not deprecated `to_tensor()`\n5. Return loss dictionary from `train_step()`\n6. Add comprehensive tests\n\n### Datasets\n1. Subclass appropriate base (`HyraxDataset` or `HyraxImageDataset`)\n2. Use `_name` attribute for registration\n3. Return dictionaries from `__getitem__()`\n4. Include metadata in returned items\n5. Handle splits (train/val/test) appropriately\n6. Use Pooch for reproducible data downloads in tests\n\n### Verbs\n1. Use clear, action-oriented names\n2. Provide helpful CLI help text\n3. Implement both `run()` and `run_cli()`\n4. Return meaningful exit codes\n5. Save results to timestamped directories\n6. Print progress and summary information\n\n## Related Skills\n\n- For testing components, see: **Hyrax Testing Strategy**\n- For overall workflow, see: **Hyrax Development Workflow**\n- For config setup, see: **Hyrax Configuration System**\n\n## References\n\n- Complete guide: [HYRAX_GUIDE.md](../../HYRAX_GUIDE.md#adding-new-components)\n- Model registry: `src/hyrax/models/model_registry.py`\n- Dataset registry: `src/hyrax/data_sets/data_set_registry.py`\n- Verb registry: `src/hyrax/verbs/verb_registry.py`"
}

{
  "name": "Hyrax Testing Strategy",
  "description": "Comprehensive guide for testing Hyrax code with pytest, including slow/fast markers, parallel execution, and fixtures",
  "version": "1.0.0",
  "tags": ["testing", "pytest", "validation"],
  "instructions": "This skill provides detailed guidance on Hyrax's testing strategy, including test markers, execution modes, and common patterns.\n\n## When to Use\n\nUse this skill when:\n- Running tests on Hyrax code changes\n- Deciding which tests to run (fast vs slow)\n- Debugging test failures\n- Adding new tests to the codebase\n- Understanding fixture usage and test patterns\n\n## Test Organization\n\n### Fast Tests vs Slow Tests\n\nHyrax uses pytest markers to categorize tests by execution time:\n\n**Fast Tests** (< 5 minutes total):\n- Marked WITHOUT `@pytest.mark.slow`\n- Run in pre-commit hooks and CI\n- Should complete in 2-5 minutes total\n- Use mocks/fixtures to avoid heavy I/O\n\n**Slow Tests** (> 5 minutes individual):\n- Marked WITH `@pytest.mark.slow`\n- Include end-to-end integration tests\n- Run separately from fast tests\n- May involve network I/O, large datasets\n\n### Test Execution Commands\n\n```bash\n# Fast tests only (DEFAULT - use after code changes)\npytest -m \"not slow\"\n# Duration: 2-5 minutes, NEVER CANCEL (wait 10+ minutes)\n\n# Fast tests with parallel execution\npytest -n auto -m \"not slow\"\n# Uses all CPU cores, faster completion\n\n# Fast tests with coverage\npytest -n auto --cov=./src --cov-report=html -m \"not slow\"\n# Generates HTML coverage report in htmlcov/\n\n# Slow tests only\npytest -m slow\n# Duration: 10-20 minutes, NEVER CANCEL (wait 30+ minutes)\n\n# All tests (fast + slow)\npytest\n# Duration: 15-25 minutes, NEVER CANCEL (wait 45+ minutes)\n\n# Single test file\npytest tests/hyrax/test_config_utils.py\n\n# Single test function\npytest tests/hyrax/test_infer.py::test_infer_basic\n\n# Verbose output for debugging\npytest -v -s tests/hyrax/test_specific.py\n```\n\n## Marking New Tests\n\n### When to Mark as Slow\n\nMark a test with `@pytest.mark.slow` if:\n- Individual test takes > 5 minutes\n- Test downloads large datasets\n- Test performs heavy computation\n- Test runs full end-to-end workflows\n\n### How to Mark Tests\n\n```python\nimport pytest\n\n# Fast test (no marker needed)\ndef test_config_loading():\n    \"\"\"Test configuration loading - fast.\"\"\"\n    config = ConfigDict()\n    assert config is not None\n\n# Slow test (add marker)\n@pytest.mark.slow\ndef test_full_training_pipeline():\n    \"\"\"Test complete training workflow - slow.\"\"\"\n    # This test trains a model end-to-end\n    result = run_full_training()\n    assert result.success\n\n# Multiple markers\n@pytest.mark.slow\n@pytest.mark.integration\ndef test_e2e_workflow():\n    \"\"\"End-to-end integration test.\"\"\"\n    pass\n```\n\n## Test Fixtures\n\n### Common Fixtures\n\nFixtures are defined in `tests/hyrax/conftest.py`:\n\n```python\n# Example fixture usage\ndef test_with_sample_data(sample_dataset):\n    \"\"\"Test using sample data fixture.\"\"\"\n    assert len(sample_dataset) > 0\n\ndef test_with_config(default_config):\n    \"\"\"Test using default config fixture.\"\"\"\n    assert default_config[\"model\"][\"name\"] is not None\n```\n\n### Data Download with Pooch\n\nTests use Pooch for reproducible downloads from Zenodo:\n- Downloads are cached locally\n- Network failures should trigger retry, not test failure\n- DOIs provide version-locked data access\n\n## Network Retry Strategy\n\n### Handling Network Failures\n\n**PyPI Installation**:\n```bash\n# If pip install fails with ReadTimeoutError:\n# 1. Wait 1-2 minutes\n# 2. Retry exact same command\n# 3. May need 3-5 attempts\npip install -e .'[dev]'\n```\n\n**Test Data Downloads**:\n- Tests using Pooch may fail on poor network\n- Retry test execution if network-related failure\n- Local cache prevents re-downloading on retry\n\n## Parallel Testing\n\n### Using pytest-xdist\n\n```bash\n# Automatic CPU detection\npytest -n auto -m \"not slow\"\n\n# Explicit worker count\npytest -n 4 -m \"not slow\"\n\n# With verbose output\npytest -n auto -v -m \"not slow\"\n```\n\n**Benefits**:\n- Faster test execution\n- Better CPU utilization\n- Scales with available cores\n\n**Limitations**:\n- May hide race conditions\n- Output interleaving in verbose mode\n- Some fixtures may not be thread-safe\n\n## Test Execution Timeouts\n\n**CRITICAL: Never cancel tests prematurely**\n\n| Test Command | Expected Duration | Minimum Timeout |\n|-------------|-------------------|----------------|\n| `pytest -m \"not slow\"` | 2-5 min | 10+ minutes |\n| `pytest -m slow` | 10-20 min | 30+ minutes |\n| `pytest` (all) | 15-25 min | 45+ minutes |\n| Single test file | 10 sec - 2 min | 5 minutes |\n\n## Debugging Test Failures\n\n### Common Failure Patterns\n\n**Config Key Not Found**:\n```python\n# Problem: Missing config key\n# Solution: Add to src/hyrax/hyrax_default_config.toml\n```\n\n**Import Errors**:\n```bash\n# Verify package installed in development mode\npip list | grep hyrax\n# Should show: hyrax <version> /path/to/src\n```\n\n**Network Timeouts**:\n```bash\n# Retry test if Pooch download fails\npytest tests/hyrax/test_that_failed.py\n```\n\n**Fixture Not Found**:\n```python\n# Check tests/hyrax/conftest.py for available fixtures\n# Import fixture if defined in different conftest.py\n```\n\n### Debugging Commands\n\n```bash\n# Run with full output\npytest -v -s tests/hyrax/test_file.py\n\n# Run with pdb on failure\npytest --pdb tests/hyrax/test_file.py\n\n# Show local variables on failure\npytest -l tests/hyrax/test_file.py\n\n# Stop on first failure\npytest -x tests/hyrax/test_file.py\n```\n\n## Pre-commit Testing\n\nPre-commit hooks run fast tests automatically:\n```bash\n# Manual pre-commit execution\npre-commit run --all-files\n# Duration: 3-8 minutes, NEVER CANCEL (wait 15+ minutes)\n\n# Only runs pytest fast tests (not slow)\n# If fast tests fail, commit is blocked\n```\n\n## Writing New Tests\n\n### Test Structure\n\n```python\nimport pytest\nfrom hyrax import Hyrax\n\nclass TestMyFeature:\n    \"\"\"Test suite for my feature.\"\"\"\n    \n    def test_basic_functionality(self):\n        \"\"\"Test basic feature behavior.\"\"\"\n        result = my_feature()\n        assert result == expected\n    \n    @pytest.mark.slow\n    def test_full_workflow(self):\n        \"\"\"Test complete workflow - slow.\"\"\"\n        # End-to-end test\n        pass\n    \n    def test_error_handling(self):\n        \"\"\"Test error cases.\"\"\"\n        with pytest.raises(ValueError):\n            my_feature(invalid_input)\n```\n\n### Best Practices\n\n1. **Keep fast tests fast**: Mock heavy operations\n2. **Use descriptive names**: Test name explains what's tested\n3. **One assertion per test**: Focus on single behavior\n4. **Use fixtures**: Avoid code duplication\n5. **Test edge cases**: Don't just test happy path\n6. **Mark slow tests**: Use `@pytest.mark.slow` appropriately\n\n## Integration with CI/CD\n\n### CI Workflow\n\n1. **Pre-commit CI**: Runs fast tests on every push\n2. **Testing and Coverage**: Full test suite with coverage reports\n3. **Smoke Tests**: Daily scheduled tests\n4. **Performance**: ASV benchmarks track performance\n\nSee `.github/workflows/testing-and-coverage.yml` for details.\n\n## Related Skills\n\n- For overall workflow, see: **Hyrax Development Workflow**\n- For adding tests, see: **Adding Hyrax Components**\n- For config in tests, see: **Hyrax Configuration System**\n\n## References\n\n- Full testing guide: [HYRAX_GUIDE.md](../../HYRAX_GUIDE.md#testing)\n- Test fixtures: `tests/hyrax/conftest.py`\n- CI workflows: `.github/workflows/`"
}
